<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Membership Application Form</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <!-- Favicon -->
    <link rel="icon" href="/public/favicon.ico" type="image/x-icon" />

    <link
      href="https://fonts.googleapis.com/css?family=Alegreya+Sans:500,400,700"
      rel="stylesheet"
    />
    <link href="/css/application.css" rel="stylesheet" />
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="logo">
          <img src="/public/logo.svg" alt="Logo" />
        </div>
        <section class="partner-details">
          <h1 id="membership-applciation">Membership application form</h1>
          <p>
            We're excited that you're interested in becoming a part of Solene.
            Tell us a little about yourself so we can get to know you better.
          </p>
        </section>
      </div>

      <div class="main-card">
        <div id="initial-form">
          <section>
            <section class="address-section">
              <div class="section-content">
                <div class="section-header">
                  <h2>Personal Details</h2>
                  <p>
                    Tell us about yourself and your partner so we can get to
                    know you better
                  </p>
                </div>
                <hr />
              </div>
            </section>

            <section class="personal-details">
              <div class="radio-group">
                <div class="radio-home">
                  <h3>Are you a part of the Isprava Family?*</h3>
                  <div class="radio-options">
                    <label class="radio-label">
                      <input
                        type="radio"
                        name="family"
                        value="isprava_homeowner"
                      />
                      <span>Isprava Homeowner</span>
                    </label>
                    <label class="radio-label">
                      <input
                        type="radio"
                        name="family"
                        value="chapter_homeowner"
                      />
                      <span>The Chapter Homeowner</span>
                    </label>
                    <label class="radio-label">
                      <input type="radio" name="family" value="lohono_platinum" />
                      <span>Lohono Platinum</span>
                    </label>
                    <label class="radio-label">
                      <input type="radio" name="family" value="not_yet" />
                      <span>Not yet</span>
                    </label>
                  </div>
                  <div class="form-grid" id="home-name-grid" style="margin-top: 16px">
                    <div
                      class="form-field"
                      id="home-name-field"
                      style="display: none"
                    >
                      <input type="text" id="home-name" placeholder=" " />
                      <label for="home-name">Home Name</label>
                    </div>
                  </div>
                </div>
                <hr />
              </div>
            </section>

            <section class="membership-info">
              <div class="form-sections">
                <div class="form-section">
                  <div class="form-group">
                    <h3>Basic Details*</h3>
                    <div class="form-grid">
                      <div class="form-field">
                        <input
                          type="text"
                          id="full-name"
                          placeholder=" "
                          required
                        />
                        <label for="full-name">Full Name*</label>
                      </div>
                      <div class="form-field">
                        <input
                          type="text"
                          id="date-of-birth"
                          placeholder="DD/MM/YYYY"
                          required
                        />
                        <label for="date-of-birth">Date of Birth*</label>
                      </div>
                      <div class="form-field phone-field">
                        <div class="country-code" id="basic-country-code">
                          <span>+91 India</span>
                          <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <polyline points="6 9 12 15 18 9"></polyline>
                          </svg>
                        </div>
                        <div class="country-dropdown">
                          <div
                            class="country-option selected"
                            data-code="+91"
                            data-country="India"
                          >
                            <span class="country-name">India</span>
                            <span class="country-dial-code">+91</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+1"
                            data-country="United States"
                          >
                            <span class="country-name">United States</span>
                            <span class="country-dial-code">+1</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+1"
                            data-country="Canada"
                          >
                            <span class="country-name">Canada</span>
                            <span class="country-dial-code">+1</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+44"
                            data-country="United Kingdom"
                          >
                            <span class="country-name">United Kingdom</span>
                            <span class="country-dial-code">+44</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+44"
                            data-country="Singapore"
                          >
                            <span class="country-name">Singapore</span>
                            <span class="country-dial-code">+65</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+971"
                            data-country="United arab emirates"
                          >
                            <span class="country-name">United arab emirates</span>
                            <span class="country-dial-code">+971</span>
                          </div>
                          <!-- Add more country options as needed -->
                        </div>
                        <div class="divider"></div>
                        <input
                          type="tel"
                          id="phone-number"
                          placeholder=" "
                          required
                        />
                        <label for="phone-number">Phone Number*</label>
                      </div>
                      <div class="form-field">
                        <input
                          type="email"
                          id="email-id"
                          placeholder=" "
                          required
                        />
                        <label for="email-id">Email ID*</label>
                      </div>
                      <div class="form-field">
                        <input
                          type="text"
                          id="linkedin-url"
                          placeholder=" "
                          required
                        />
                        <label for="linkedin-url">LinkedIn Profile (URL)</label>
                      </div>
                      <div class="form-field">
                        <input
                          type="text"
                          id="social-media-handle"
                          placeholder=" "
                        />
                        <label for="social-media-handle"
                          >Social Media Handle (URL)</label
                        >
                      </div>
                    </div>
                  </div>
                  <hr />
                </div>

                <div class="form-section">
                  <div class="form-group">
                    <h3>Permanent Address*</h3>
                    <div class="form-grid">
                      <div class="form-field">
                        <input
                          type="text"
                          id="address-line-1"
                          placeholder=" "
                          required
                        />
                        <label for="address-line-1">Address Line 1*</label>
                        <span class="helper-text">Area, Street name, etc.</span>
                      </div>
                      <div class="form-field">
                        <input
                          type="text"
                          id="address-line-2"
                          placeholder=" "
                          required
                        />
                        <label for="address-line-2">Address Line 2*</label>
                        <span class="helper-text"
                          >Apartment No., Apartment name, etc.</span
                        >
                      </div>
                      <div class="form-field">
                        <input
                          type="text"
                          id="pincode"
                          placeholder=" "
                          required
                        />
                        <label for="pincode">Pincode*</label>
                      </div>
                      <div class="form-field">
                        <input type="text" id="state" placeholder=" " required />
                        <label for="state">State*</label>
                      </div>
                    </div>
                  </div>
                  <hr />
                </div>

                <div
                  class="form-section"
                  id="goa-address-section"
                  style="display: none"
                >
                <div class="form-group">
                  <h3>Goa Address</h3>
                  <div class="form-grid">
                    <div class="form-field">
                      <input
                        type="text"
                        id="goa-address-line-1"
                        placeholder=" "
                      />
                      <label for="goa-address-line-1">Address Line 1</label>
                      <span class="helper-text">Area, Street name, etc.</span>
                    </div>
                    <div class="form-field">
                      <input
                        type="text"
                        id="goa-address-line-2"
                        placeholder=" "
                      />
                      <label for="goa-address-line-2">Address Line 2</label>
                      <span class="helper-text"
                        >Apartment No., Apartment name, etc.</span
                      >
                    </div>
                    <div class="form-field">
                      <input type="text" id="goa-pincode" placeholder=" " />
                      <label for="goa-pincode">Pincode</label>
                    </div>
                    <div class="form-field">
                      <input
                        type="text"
                        id="goa-state"
                        placeholder=" "
                        value="Goa"
                        disabled
                      />
                      <label for="goa-state">State</label>
                    </div>
                  </div>
                </div>
                  <hr />
                </div>

                <div class="form-section">
                  <div class="form-group">
                    <h3>Partner's Details</h3>
                    <div class="form-grid">
                      <div class="form-field">
                        <input
                          type="text"
                          id="partner-full-name"
                          placeholder=" "
                          required
                        />
                        <label for="partner-full-name">Full Name</label>
                      </div>
                      <div class="form-field">
                        <input
                          type="text"
                          id="partner-date-of-birth"
                          placeholder="DD/MM/YYYY"
                          required
                        />
                        <label
                          for="partner-date-of-birth"
                          style="padding-right: 8px"
                          >Date of Birth</label
                        >
                      </div>
                      <div class="form-field phone-field">
                        <div class="country-code">
                          <span>+91 India</span>
                          <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                          >
                            <polyline points="6 9 12 15 18 9"></polyline>
                          </svg>
                        </div>
                        <div class="country-dropdown">
                          <div
                            class="country-option selected"
                            data-code="+91"
                            data-country="India"
                          >
                            <span class="country-name">India</span>
                            <span class="country-dial-code">+91</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+1"
                            data-country="United States"
                          >
                            <span class="country-name">United States</span>
                            <span class="country-dial-code">+1</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+1"
                            data-country="Canada"
                          >
                            <span class="country-name">Canada</span>
                            <span class="country-dial-code">+1</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+44"
                            data-country="United Kingdom"
                          >
                            <span class="country-name">United Kingdom</span>
                            <span class="country-dial-code">+44</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+44"
                            data-country="Singapore"
                          >
                            <span class="country-name">Singapore</span>
                            <span class="country-dial-code">+65</span>
                          </div>
                          <div
                            class="country-option"
                            data-code="+971"
                            data-country="United arab emirates"
                          >
                            <span class="country-name">United arab emirates</span>
                            <span class="country-dial-code">+971</span>
                          </div>
                          <!-- Add more country options as needed -->
                        </div>
                        <div class="divider"></div>
                        <input
                          type="tel"
                          id="partner-phone-number"
                          placeholder=" "
                          required
                        />
                        <label for="partner-phone-number">Phone Number</label>
                      </div>
                      <div class="form-field">
                        <input
                          type="email"
                          id="partner-email-id"
                          placeholder=" "
                          required
                        />
                        <label for="partner-email-id">Email ID</label>
                      </div>
                      <div class="form-field">
                        <input
                          type="text"
                          id="partner-anniversary"
                          placeholder="DD/MM/YYYY"
                          required
                        />
                        <label
                          for="partner-anniversary"
                          style="padding-right: 12px"
                          >Anniversary</label
                        >
                      </div>
                      <div class="form-field">
                        <input
                          type="text"
                          id="partner-social-media-handle"
                          placeholder=" "
                          required
                        />
                        <label for="partner-social-media-handle"
                          >Social Media Handle (URL)</label
                        >
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </section>
        </div>

        <div id="dependant-form">
          <div class="card-header">
            <h2>Dependant Membership</h2>
            <p class="card-description">
              Apply for dependant membership for your children or parent
            </p>
            <div class="separator"></div>
          </div>

          <div class="card-content" id="dependants-container">
            <div class="form-section">
              <h3>Dependant 1</h3>
              <div class="form-grid">
                <div class="form-field">
                  <input
                    type="text"
                    id="dependant-1-full-name"
                    placeholder=" "
                  />
                  <label for="dependant-1-full-name">Full Name</label>
                </div>
                <div class="form-field">
                  <input
                    type="text"
                    id="dependant-1-date-of-birth"
                    placeholder="DD/MM/YYYY"
                  />
                  <label
                    for="dependant-1-date-of-birth"
                    style="padding-right: 6px"
                    >Date of Birth</label
                  >
                </div>
                <div class="form-field phone-field">
                  <div class="country-code" id="dependant-1-country-code">
                    <span>+91 India</span>
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </div>
                  <div class="country-dropdown dependent-1-country-code">
                    <div
                      class="country-option selected"
                      data-code="+91"
                      data-country="India"
                    >
                      <span class="country-name">India</span>
                      <span class="country-dial-code">+91</span>
                    </div>
                    <div
                      class="country-option"
                      data-code="+1"
                      data-country="United States"
                    >
                      <span class="country-name">United States</span>
                      <span class="country-dial-code">+1</span>
                    </div>
                    <div
                      class="country-option"
                      data-code="+1"
                      data-country="Canada"
                    >
                      <span class="country-name">Canada</span>
                      <span class="country-dial-code">+1</span>
                    </div>
                    <div
                      class="country-option"
                      data-code="+44"
                      data-country="United Kingdom"
                    >
                      <span class="country-name">United Kingdom</span>
                      <span class="country-dial-code">+44</span>
                    </div>
                    <div
                      class="country-option"
                      data-code="+65"
                      data-country="Singapore"
                    >
                      <span class="country-name">Singapore</span>
                      <span class="country-dial-code">+65</span>
                    </div>
                    <div
                      class="country-option"
                      data-code="+971"
                      data-country="United arab emirates"
                    >
                      <span class="country-name">United arab emirates</span>
                      <span class="country-dial-code">+971</span>
                    </div>
                  </div>
                  <div class="divider"></div>
                  <input
                    type="tel"
                    id="dependant-1-phone-number"
                    placeholder=" "
                  />
                  <label for="dependant-1-phone-number">Phone Number</label>
                </div>
                <div class="form-field">
                  <input
                    type="email"
                    id="dependant-1-email"
                    placeholder=" "
                    required
                  />
                  <label for="dependant-1-email">Email ID</label>
                </div>
                <div class="form-field">
                  <select id="dependant-1-relationship" required>
                    <option value="" disabled selected></option>
                    <option value="mother">Mother</option>
                    <option value="father">Father</option>
                    <option value="son">Son</option>
                    <option value="daughter">Daughter</option>
                  </select>
                  <label for="dependant-1-relationship">Relationship</label>
                </div>
                <div class="form-field">
                  <input
                    type="text"
                    id="dependant-1-social-media"
                    placeholder=" "
                  />
                  <label for="dependant-1-social-media"
                    >Social Media Handle</label
                  >
                </div>
              </div>
            </div>

            <div class="separator"></div>

            <div class="add-dependant">
              <button class="btn-outline" id="add-dependant-btn">
                Add Dependant
              </button>
            </div>
          </div>
        </div>

        <div id="additional-form">
          <div class="card-header">
            <h2>Additional Information</h2>
            <p class="card-description">Where did you hear about Solene?</p>
            <div class="separator"></div>
          </div>

          <div class="card-content">
            <div class="form-section">
              <label class="section-label"
                >How did you hear about Solene? (Select all that apply) *</label
              >
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" id="member" />
                  <label for="member">Via a member</label>
                  <div></div>
                </div>
                <div
                  class="reference-details"
                  id="reference-details"
                  style="display: none; position: relative"
                >
                  <div class="form-grid">
                    <div class="form-field">
                      <input
                        type="text"
                        id="reference-full-name"
                        placeholder=" "
                      />
                      <label for="reference-full-name">Full Name</label>
                    </div>
                    <div class="form-field phone-field">
                      <div class="country-code">
                        <span>+91 India</span>
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                      </div>
                      <div class="divider"></div>
                      <input
                        type="tel"
                        id="reference-phone-number"
                        placeholder=" "
                      />
                      <label for="reference-phone-number">Phone Number</label>
                    </div>
                    <div class="form-field">
                      <input
                        type="text"
                        id="reference-relationship"
                        placeholder=" "
                      />
                      <label for="reference-relationship">Relationship</label>
                    </div>
                  </div>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="social" />
                  <label for="social">Social Media</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="website" />
                  <label for="website">Website</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" id="other" />
                  <label for="other">Other</label>
                </div>
                <div class="other-input">
                  <input type="text" placeholder="Type here" disabled />
                </div>
              </div>
              <span class="error-message" id="source-error"></span>
            </div>

            <div class="form-section">
              <label class="section-label"
                >Why do you wish to be a part of the Solene community?</label
              >
              <textarea placeholder="Type here" id="why"></textarea>
            </div>

            <div class="form-section" id="how">
              <label class="section-label"
                >How do you see yourself making use of the club's facilities and
                services?</label
              >
              <textarea placeholder="Type here"></textarea>
            </div>
          </div>
        </div>

        <div class="terms-section" style="display: none">
          <label class="checkbox-container">
            <input type="checkbox" id="terms" required />
            <span class="checkmark"></span>
            <span class="terms-text">
              I agree to the
              <a href="#" class="terms-link">Terms & Conditions</a> and
              <a href="#" class="terms-link">Privacy Policy.</a>
            </span>
          </label>
        </div>

        <footer class="form-navigation">
          <div class="progress-bar">
            <div class="progress" style="width: 33.33%"></div>
          </div>
          <div class="navigation-buttons">
            <div><button class="btn-previous">Previous</button></div>
            <div>
              <button class="btn-next" id="next-button" type="button">
                Next
              </button>
              <a class="skip" id="skip" href="/success.html">Skip ></a>
            </div>
          </div>
        </footer>
      </div>
    </div>

    <div id="toast" class="toast"></div>
    <script>
      // Add these validation functions at the top of your file
      // function validateMembershipType() {
      //   const selectedFamily = document.querySelector('input[name="family"]:checked');
      //   const errorElement = document.createElement('span');
      //   errorElement.className = 'error-message';

      //   if (!selectedFamily) {
      //     const radioGroup = document.querySelector('.radio-group');
      //     const existingError = radioGroup.querySelector('.error-message');

      //     if (!existingError) {
      //       errorElement.textContent = 'Please select a membership type';
      //       radioGroup.appendChild(errorElement);
      //     }
      //     return false;
      //   }

      //   const existingError = document.querySelector('.radio-group .error-message');
      //   if (existingError) {
      //     existingError.remove();
      //   }
      //   return true;
      // }

      // function validateHomeNameField() {
      //   const selectedFamily = document.querySelector('input[name="family"]:checked')?.value;
      //   if (selectedFamily === 'isprava_homeowner' || selectedFamily === 'chapter_homeowner') {
      //     const homeName = document.getElementById('home-name');
      //     if (!homeName.value.trim()) {
      //       const errorElement = document.getElementById('home-name-error') || document.createElement('span');
      //       errorElement.id = 'home-name-error';
      //       errorElement.className = 'error-message';
      //       errorElement.textContent = 'Please enter your home name';

      //       if (!document.getElementById('home-name-error')) {
      //         homeName.parentNode.appendChild(errorElement);
      //       }
      //       return false;
      //     }
      //   }
      //   return true;
      // }
      // Form validation rules
      // Add this function after your VALIDATION_RULES constant
      function validateDateField(field) {
        const value = field.value.trim();
        const datePattern =
          /^(0[1-9]|[12][0-9]|3[01])\/(0[1-9]|1[012])\/(19|20)\d\d$/;

        // Remove any existing error message
        const existingError =
          field.parentElement.querySelector(".error-message");
        if (existingError) {
          existingError.remove();
        }

        // Allow empty value if field is not required
        if (!value && !field.hasAttribute("required")) {
          field.classList.remove("error");
          return true;
        }

        // Required field validation
        if (!value && field.hasAttribute("required")) {
          showFieldError(field, "This field is required");
          return false;
        }

        // Pattern validation for non-empty values
        if (value && !datePattern.test(value)) {
          showFieldError(field, "Please enter date in DD/MM/YYYY format");
          return false;
        }

        if (value) {
          const [day, month, year] = value.split("/").map(Number);
          const date = new Date(year, month - 1, day);
          const today = new Date();

          // Check if it's a valid date
          if (
            date.getDate() !== day ||
            date.getMonth() !== month - 1 ||
            date.getFullYear() !== year
          ) {
            showFieldError(field, "Please enter a valid date");
            return false;
          }

          // Check if date is not in future
          if (date > today) {
            showFieldError(field, "Date cannot be in future");
            return false;
          }
        }

        field.classList.remove("error");
        return true;
      }

      function showFieldError(field, message) {
        field.classList.add("error");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error-message";
        errorDiv.textContent = message;
        field.parentElement.appendChild(errorDiv);
      }

      // Update your VALIDATION_RULES object for date fields
      const VALIDATION_RULES = {
        // ...existing rules...
        "date-of-birth": {
          required: true,
          validate: (field) => validateDateField(field),
        },
        "partner-date-of-birth": {
          conditionallyRequired: true,
          validate: (field) => validateDateField(field),
        },
        "partner-anniversary": {
          conditionallyRequired: true,
          validate: (field) => validateDateField(field),
        },
      };

      // Add event listeners for date inputs
      document.addEventListener("DOMContentLoaded", function () {
        const dateFields = document.querySelectorAll(
          'input[placeholder="DD/MM/YYYY"]'
        );

        dateFields.forEach((field) => {
          field.addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");
            if (value.length > 8) value = value.slice(0, 8);

            if (value.length >= 4) {
              value =
                value.slice(0, 2) +
                "/" +
                value.slice(2, 4) +
                "/" +
                value.slice(4);
            } else if (value.length >= 2) {
              value = value.slice(0, 2) + "/" + value.slice(2);
            }

            e.target.value = value;
          });

          field.addEventListener("blur", function () {
            validateDateField(this);
          });
        });
      });

      // Update the date input event listeners
      document.addEventListener("DOMContentLoaded", function () {
        const dateFields = document.querySelectorAll(
          'input[placeholder="DD/MM/YYYY"]'
        );

        dateFields.forEach((field) => {
          // Handle input formatting
          field.addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");

            // Allow backspace and delete
            if (
              e.inputType === "deleteContentBackward" ||
              e.inputType === "deleteContentForward"
            ) {
              return;
            }

            if (value.length > 8) value = value.slice(0, 8);

            if (value.length >= 4) {
              value =
                value.slice(0, 2) +
                "/" +
                value.slice(2, 4) +
                "/" +
                value.slice(4);
            } else if (value.length >= 2) {
              value = value.slice(0, 2) + "/" + value.slice(2);
            }

            e.target.value = value;
          });

          // Handle keydown for delete and backspace
          field.addEventListener("keydown", function (e) {
            if (e.key === "Backspace" || e.key === "Delete") {
              const start = this.selectionStart;
              const end = this.selectionEnd;

              if (start === end && this.value[start - 1] === "/") {
                e.preventDefault();
                this.setSelectionRange(start - 1, start - 1);
              }
            }
          });

          // Validate on blur
          field.addEventListener("blur", function () {
            validateDateField(this);
          });
        });
      });
      // Update your validateField function to use custom validation
      function validateField(field) {
        const rules = VALIDATION_RULES[field.id];
        if (!rules) return true;

        if (rules.validate) {
          return rules.validate(field);
        }

        // ... rest of your existing validation logic
      }
      // Add this function to check all required fields
      function checkRequiredFields() {
        // Check family type selection
        const familyType = document.querySelector(
          'input[name="family"]:checked'
        );
        if (!familyType) return false;

        // Check home name if applicable
        if (
          ["isprava_homeowner", "chapter_homeowner"].includes(familyType.value)
        ) {
          const homeName = document.getElementById("home-name");
          if (!homeName.value.trim()) return false;
        }

        // Check all required fields
        const requiredFields = document.querySelectorAll(
          "#initial-form input[required]"
        );
        for (const field of requiredFields) {
          if (!validateField(field)) return false;
        }

        return true;
      }

      // Add input event listeners to all form fields
      function setupFormValidation() {
        // Add event listeners to family type radio buttons
        document.querySelectorAll('input[name="family"]').forEach((radio) => {
          radio.addEventListener("change", toggleNextButton);
        });

        // Add event listeners to all required inputs
        document
          .querySelectorAll(
            "#initial-form input[required], #initial-form select[required]"
          )
          .forEach((field) => {
            ["input", "change", "blur"].forEach((eventType) => {
              field.addEventListener(eventType, toggleNextButton);
            });
          });
      }

      // Function to toggle Next button state
      function toggleNextButton() {
        const nextButton = document.getElementById("next-button");
        const isValid = checkRequiredFields();

        nextButton.disabled = !isValid;
        nextButton.classList.toggle("disabled", !isValid);
      }

      // Initialize validation on page load
      document.addEventListener("DOMContentLoaded", function () {
        setupFormValidation();
        toggleNextButton(); // Initial check
      });

      // Initialize country dropdowns when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initializeAllCountryDropdowns();

        // Initialize existing dependant dropdowns
        const existingPhoneFields = document.querySelectorAll(
          "#dependants-container .phone-field"
        );
        existingPhoneFields.forEach((phoneField) => {
          initializeCountryDropdown(phoneField);
        });
      });

      function initializeAllCountryDropdowns() {
        document.querySelectorAll(".country-code").forEach((countryCode) => {
          countryCode.addEventListener("click", function (e) {
            e.stopPropagation();

            const dropdown =
              this.closest(".phone-field").querySelector(".country-dropdown");
            // dropdown.style.border = "solid green";
            // Close all other dropdowns first
            document.querySelectorAll(".country-dropdown").forEach((d) => {
              if (d !== dropdown) {
                d.classList.remove("active");
              }
            });

            // Toggle current dropdown
            dropdown.classList.add("active");
          });
        });

        // Handle country selection
        document.querySelectorAll(".country-option").forEach((option) => {
          option.addEventListener("click", function (e) {
            e.stopPropagation();
            const phoneField = this.closest(".phone-field");
            const countryCode = phoneField.querySelector(".country-code span");
            const dropdown = phoneField.querySelector(".country-dropdown");

            // Update selected country
            countryCode.textContent = `${this.dataset.code} ${this.dataset.country}`;

            // Update selected state
            phoneField.querySelectorAll(".country-option").forEach((opt) => {
              opt.classList.remove("selected");
            });
            this.classList.add("selected");

            // Hide dropdown
            dropdown.classList.remove("active");
          });
        });

        // Close dropdowns when clicking outside
        document.addEventListener("click", function (e) {
          if (!e.target.closest(".phone-field")) {
            document
              .querySelectorAll(".country-dropdown")
              .forEach((dropdown) => {
                dropdown.classList.remove("active");
              });
          }
        });
      }

      function initializeCountryDropdown(phoneField) {
        const countryCode = phoneField.querySelector(".country-code");
        const dropdown = phoneField.querySelector(".country-dropdown");
        const countryOptions = phoneField.querySelectorAll(".country-option");

        // Toggle dropdown
        // countryCode.addEventListener("click", function (e) {
        //   e.stopPropagation();
        //   // Close all other dropdowns
        //   document.querySelectorAll(".country-dropdown").forEach((d) => {
        //     if (d !== dropdown) {
        //       d.classList.remove("active");
        //     }
        //   });
        //   dropdown.classList.toggle("active");
        // });

        // Handle country selection
        countryOptions.forEach((option) => {
          option.addEventListener("click", function (e) {
            e.stopPropagation();
            const code = this.dataset.code;
            const country = this.dataset.country;

            // Update display
            countryCode.querySelector(
              "span"
            ).textContent = `${code} ${country}`;

            // Update selected state
            countryOptions.forEach((opt) => opt.classList.remove("selected"));
            this.classList.add("selected");

            // Close dropdown
            dropdown.classList.remove("active");
          });
        });
      }

      // Update the initializeNewDependantDropdowns function
      function initializeNewDependantDropdowns(newSection) {
        const phoneFields = newSection.querySelectorAll(".phone-field");
        phoneFields.forEach((phoneField) => {
          initializeCountryDropdown(phoneField);
        });
      }
      function validateTermsAndConditions() {
        const termsCheckbox = document.getElementById("terms");
        const termsSection = document.querySelector(".terms-section");

        if (!termsCheckbox.checked) {
          const errorDiv = document.createElement("div");
          errorDiv.className = "error-message";
          errorDiv.textContent = "Please accept the Terms & Conditions";

          // Remove any existing error message
          const existingError = termsSection.querySelector(".error-message");
          if (existingError) {
            existingError.remove();
          }

          termsSection.appendChild(errorDiv);
          return false;
        }

        // Remove error message if terms are accepted
        const existingError = termsSection.querySelector(".error-message");
        if (existingError) {
          existingError.remove();
        }
        return true;
      }
      // Add click handler to close dropdowns when clicking outside
      document.addEventListener("click", function (e) {
        if (!e.target.closest(".phone-field")) {
          document.querySelectorAll(".country-dropdown").forEach((dropdown) => {
            dropdown.classList.remove("active");
          });
        }
      });

      function convertDateFormat(dateString) {
        if (!dateString) return "";

        // Check if date is in DD/MM/YYYY format
        const parts = dateString.split("/");
        if (parts.length === 3) {
          const [day, month, year] = parts;
          return `${year}-${month}-${day}`;
        }
        return dateString;
      }

      function isAnyPartnerFieldFilled() {
        const partnerFields = [
          "partner-full-name",
          "partner-date-of-birth",
          "partner-phone-number",
          "partner-email-id",
          "partner-anniversary",
          "partner-social-media-handle",
        ];

        return partnerFields.some((fieldId) => {
          const field = document.getElementById(fieldId);
          return field && field.value.trim() !== "";
        });
      }

      function isAnyDependentFieldFilled(sectionIndex) {
        const fields = [
          `dependant-${sectionIndex}-full-name`,
          `dependant-${sectionIndex}-date-of-birth`,
          `dependant-${sectionIndex}-phone-number`,
          `dependant-${sectionIndex}-email`,
          `dependant-${sectionIndex}-relationship`,
          `dependant-${sectionIndex}-social-media`,
        ];

        return fields.some((fieldId) => {
          const field = document.getElementById(fieldId);
          return field && field.value.trim() !== "";
        });
      }

      function hasDependantData() {
        const dependantSections = document.querySelectorAll(
          "#dependants-container .form-section"
        );
        return Array.from(dependantSections).some((section, index) => {
          const sectionIndex = index + 1;
          return isAnyDependentFieldFilled(sectionIndex);
        });
      }

      function hasAdditionalInfoData() {
        // Check if any source is selected
        const sourceCheckboxes = document.querySelectorAll(
          '.checkbox-group input[type="checkbox"]'
        );
        const isAnySourceSelected = Array.from(sourceCheckboxes).some(
          (checkbox) => checkbox.checked
        );

        // Check member reference details if selected
        const memberCheckbox = document.getElementById("member");
        const referenceData = memberCheckbox?.checked
          ? {
              fullName: document
                .getElementById("reference-full-name")
                ?.value.trim(),
              phoneNumber: document
                .getElementById("reference-phone-number")
                ?.value.trim(),
              relationship: document
                .getElementById("reference-relationship")
                ?.value.trim(),
            }
          : null;

        // Check why and how fields
        const whyField = document.getElementById("why")?.value;
        const howField = document.getElementById("how")?.value;

        return (
          isAnySourceSelected ||
          (referenceData &&
            (referenceData.fullName ||
              referenceData.phoneNumber ||
              referenceData.relationship)) ||
          whyField ||
          howField
        );
      }
      // Validate a single field
      function validateField(field) {
        const rules = VALIDATION_RULES[field.id];
        if (!rules) return true;

        let isValid = true;
        let errorMessage = "";

        // Remove any existing error message
        const existingError =
          field.parentElement.querySelector(".error-message");
        if (existingError) {
          existingError.remove();
        }

        // Check if field is conditionally required
        const isRequired = rules.conditionallyRequired
          ? isAnyPartnerFieldFilled() && field.id.startsWith("partner-")
          : rules.required;

        // Required field validation
        if (isRequired && !field.value.trim()) {
          isValid = false;
          errorMessage = rules.conditionallyRequired
            ? "This field is required when any partner detail is provided"
            : `The Field is required`;
        }

        // Pattern validation (only if field has value or is required)
        if (
          isValid &&
          field.value.trim() &&
          rules.pattern &&
          !rules.pattern.test(field.value.trim())
        ) {
          isValid = false;
          errorMessage = rules.message;
        }

        // Minimum length validation (only if field has value or is required)
        if (
          isValid &&
          field.value.trim() &&
          rules.minLength &&
          field.value.trim().length < rules.minLength
        ) {
          isValid = false;
          errorMessage = `Must be at least ${rules.minLength} characters`;
        }

        // Display error message if validation failed
        if (!isValid) {
          const errorDiv = document.createElement("div");
          errorDiv.className = "error-message";
          errorDiv.textContent = errorMessage;
          field.parentElement.appendChild(errorDiv);
          field.classList.add("error");
        } else {
          field.classList.remove("error");
        }

        return isValid;
      }

      function validateDependents() {
        const dependantSections = document.querySelectorAll(
          "#dependants-container .form-section"
        );
        let isValid = true;

        dependantSections.forEach((section, index) => {
          const sectionIndex = index + 1;

          if (isAnyDependentFieldFilled(sectionIndex)) {
            // Required fields if any field is filled
            const requiredFields = [
              {
                id: `dependant-${sectionIndex}-full-name`,
                label: "Full Name",
                pattern: /^[a-zA-Z\s'-]+$/,
              },
              {
                id: `dependant-${sectionIndex}-date-of-birth`,
                label: "Date of Birth",
                pattern:
                  /^(0[1-9]|[12][0-9]|3[01])\/(0[1-9]|1[012])\/(19|20)\d\d$/,
              },
              {
                id: `dependant-${sectionIndex}-phone-number`,
                label: "Phone Number",
                pattern: /^\d{10}$/,
              },
              {
                id: `dependant-${sectionIndex}-email`,
                label: "Email",
                pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
              },
              {
                id: `dependant-${sectionIndex}-relationship`,
                label: "Relationship",
                pattern: /.+/,
              },
            ];

            requiredFields.forEach((field) => {
              const element = document.getElementById(field.id);
              const value = element.value.trim();

              // Remove existing error message
              const existingError =
                element.parentElement.querySelector(".error-message");
              if (existingError) {
                existingError.remove();
              }
              element.classList.remove("error");

              if (!value) {
                isValid = false;
                const errorDiv = document.createElement("div");
                errorDiv.className = "error-message";
                errorDiv.textContent = `${field.label} is required`;
                element.parentElement.appendChild(errorDiv);
                element.classList.add("error");
              } else if (field.pattern && !field.pattern.test(value)) {
                isValid = false;
                const errorDiv = document.createElement("div");
                errorDiv.className = "error-message";
                errorDiv.textContent = `Please enter a valid ${field.label.toLowerCase()}`;
                element.parentElement.appendChild(errorDiv);
                element.classList.add("error");
              }
            });
          }
        });

        return isValid;
      }

      document.getElementById("member").addEventListener("change", function () {
        const referenceDetails = document.getElementById("reference-details");
        const referenceFullName = document.getElementById(
          "reference-full-name"
        );
        const referencePhoneNumber = document.getElementById(
          "reference-phone-number"
        );
        const referenceRelationship = document.getElementById(
          "reference-relationship"
        );

        if (this.checked) {
          referenceDetails.style.display = "block";
          referenceFullName.setAttribute("required", "true");
          referencePhoneNumber.setAttribute("required", "true");
          referenceRelationship.setAttribute("required", "true");
        } else {
          referenceDetails.style.display = "none";
          referenceFullName.removeAttribute("required");
          referencePhoneNumber.removeAttribute("required");
          referenceRelationship.removeAttribute("required");
        }
      });

      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.classList.remove("success", "error");
        toast.classList.add(type);
        toast.textContent = message;
        toast.style.display = "block";
        setTimeout(() => {
          toast.style.display = "none";
        }, 3000);
      }

      const partnerFields = document.querySelectorAll('[id^="partner-"]');

      function saveFormData() {
        const formData = {
          familyType:
            document.querySelector('input[name="family"]:checked')?.value || "",
          homeName: document.getElementById("home-name")?.value || "",
          basicDetails: {
            fullName: document.getElementById("full-name")?.value || "",
            dateOfBirth: document.getElementById("date-of-birth")?.value || "",
            countryCode: document
              .querySelector("#basic-country-code span")
              .textContent.split(" ")[0],
            phoneNumber: document.getElementById("phone-number")?.value || "",
            emailId: document.getElementById("email-id")?.value || "",
            linkedinUrl: document.getElementById("linkedin-url")?.value || "", // Add this line
            socialMediaHandle:
              document.getElementById("social-media-handle")?.value || "",
          },
          address: {
            line1: document.getElementById("address-line-1")?.value || "",
            line2: document.getElementById("address-line-2")?.value || "",
            pincode: document.getElementById("pincode")?.value || "",
            state: document.getElementById("state")?.value || "",
          },
          goaAddress: {
            line1: document.getElementById("goa-address-line-1")?.value || "",
            line2: document.getElementById("goa-address-line-2")?.value || "",
            pincode: document.getElementById("goa-pincode")?.value || "",
            state: "Goa",
          },
          partnerDetails: {
            fullName: document.getElementById("partner-full-name")?.value || "",
            dateOfBirth:
              document.getElementById("partner-date-of-birth")?.value || "",
            phoneNumber:
              document.getElementById("partner-phone-number")?.value || "",
            emailId: document.getElementById("partner-email-id")?.value || "",
            anniversary:
              document.getElementById("partner-anniversary")?.value || "",
            socialMediaHandle:
              document.getElementById("partner-social-media-handle")?.value ||
              "",
          },
        };

        localStorage.setItem("membershipFormData", JSON.stringify(formData));
      }

      function saveDependantsData() {
        const dependants = [];
        const dependantSections = document.querySelectorAll(
          "#dependants-container .form-section"
        );

        dependantSections.forEach((section, index) => {
          const dependant = {
            fullName:
              document.getElementById(`dependant-${index + 1}-full-name`)
                ?.value || "",
            dateOfBirth:
              document.getElementById(`dependant-${index + 1}-date-of-birth`)
                ?.value || "",
            phoneNumber:
              document.getElementById(`dependant-${index + 1}-phone-number`)
                ?.value || "",
            emailId:
              document.getElementById(`dependant-${index + 1}-email`)?.value ||
              "",
            relationship:
              document.getElementById(`dependant-${index + 1}-relationship`)
                ?.value || "",
            socialMediaHandle:
              document.getElementById(`dependant-${index + 1}-social-media`)
                ?.value || "",
          };
          dependants.push(dependant);
        });

        localStorage.setItem("dependantsData", JSON.stringify(dependants));
        return dependants;
      }

      function validateSourceCheckboxes() {
        const checkboxes = document.querySelectorAll(
          ".checkbox-group input[type='checkbox']"
        );
        const errorElement = document.getElementById("source-error");
        const isMemberChecked = document.getElementById("member").checked;
        const isAnyChecked = Array.from(checkboxes).some(
          (checkbox) => checkbox.checked
        );

        if (!isAnyChecked) {
          errorElement.textContent = "Please select at least one option";
          errorElement.style.display = "block";
          return false;
        }

        if (isMemberChecked) {
          const referenceFullName = document
            .getElementById("reference-full-name")
            .value.trim();
          const referencePhoneNumber = document
            .getElementById("reference-phone-number")
            .value.trim();
          const referenceRelationship = document
            .getElementById("reference-relationship")
            .value.trim();

          if (
            !referenceFullName ||
            !referencePhoneNumber ||
            !referenceRelationship
          ) {
            const errorDiv = document.createElement("div");
            errorDiv.className = "error-message";
            errorDiv.textContent =
              "Please fill all required reference details (Full Name, Phone Number, Relationship)";
            const referenceDetails =
              document.querySelector("#reference-details");
            referenceDetails.appendChild(errorDiv);
            return false;
          }
        }

        errorElement.textContent = "";
        errorElement.style.display = "none";
        return true;
      }

      document
        .querySelectorAll(".form-field input, .form-field select")
        .forEach((input) => {
          input.addEventListener("focus", function () {
            const label = this.nextElementSibling;
            if (label && label.tagName === "LABEL") {
              label.classList.add("active");
            }
          });

          input.addEventListener("blur", function () {
            const label = this.nextElementSibling;
            if (label && label.tagName === "LABEL" && this.value === "") {
              label.classList.remove("active");
            }
            if (this.hasAttribute("required")) {
              validateField(this);
            }
          });
        });

      document.querySelectorAll('input[name="family"]').forEach((radio) => {
        radio.addEventListener("change", function () {
          const homeNameField = document.getElementById("home-name-field");
          const goaAddressSection = document.getElementById(
            "goa-address-section"
          );

          if (
            this.value === "isprava_homeowner" ||
            this.value === "chapter_homeowner"
          ) {
            homeNameField.style.display = "block";
            goaAddressSection.style.display = "none";
          } else if (
            this.value === "not_yet" ||
            this.value === "lohono_platinum"
          ) {
            homeNameField.style.display = "none";
            goaAddressSection.style.display = "block";
          } else {
            homeNameField.style.display = "none";
            goaAddressSection.style.display = "none";
          }
        });
      });

      function validateForm() {
        const fields = document.querySelectorAll(
          "#initial-form input[required]"
        );
        let isValid = true;
        const familyType = document.querySelector(
          'input[name="family"]:checked'
        );

        // Validate family type selection
        if (!familyType) {
          isValid = false;
          const radioGroup = document.querySelector(".radio-group");
          if (!radioGroup.querySelector(".error-message")) {
            const errorDiv = document.createElement("div");
            errorDiv.className = "error-message";
            errorDiv.textContent = "Please select your family type";
            const radioOptions = document.querySelector(".radio-options");
            radioGroup.appendChild(errorDiv);
          }
        } else {
          const radioGroup = document.querySelector(".radio-group");
          const existingError = radioGroup.querySelector(".error-message");
          if (existingError) {
            existingError.remove();
          }

          // Validate home name if applicable
          if (
            ["isprava_homeowner", "chapter_homeowner"].includes(
              familyType.value
            )
          ) {
            const homeName = document.getElementById("home-name");
            if (!homeName.value.trim()) {
              isValid = false;
              const errorDiv = document.createElement("div");
              errorDiv.className = "error-message";
              errorDiv.textContent = "Please enter your home name";
              homeName.parentElement.appendChild(errorDiv);
              homeName.classList.add("error");
            }
          }
        }

        // Validate all required fields
        fields.forEach((field) => {
          if (!validateField(field)) {
            isValid = false;
          }
        });

        return isValid;
      }

      const initialForm = document.getElementById("initial-form");
      const dependantForm = document.getElementById("dependant-form");
      const additionalForm = document.getElementById("additional-form");
      const termsSection = document.querySelector(".terms-section");
      const nextButton = document.getElementById("next-button");
      const skipButton = document.getElementById("skip");
      const previousButton = document.querySelector(".btn-previous");
      const progressBar = document.querySelector(".progress");
      const membershipForm = document.querySelector("#membership-applciation");

      dependantForm.style.display = "none";
      additionalForm.style.display = "none";

      nextButton.addEventListener("click", async function (e) {
        if (nextButton.textContent.trim().toLowerCase() === "next") {
          // Validate membership type
          const isValidForm = validateForm();

          if (!isValidForm) {
            // Find the first error and scroll to it
            const firstError = document.querySelector(".error-message");
            if (firstError) {
              firstError.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
            }
            return;
          }
        }

        try {
          if (nextButton.textContent.trim().toLowerCase() === "next") {
            // Disable button and show loading state
            nextButton.disabled = true;
            nextButton.classList.add("loading");
            let originalText = nextButton.textContent;
            nextButton.textContent = "Loading...";
            // Save form data to localStorage
            saveFormData();

            // Check if applicationSlug exists
            const applicationSlug = localStorage.getItem("applicationSlug");
            if (applicationSlug) {
              // Show next form
              const formData = JSON.parse(
                localStorage.getItem("membershipFormData")
              );
              const membershipType = formData?.familyType || "";
              showToast("Application exists. Moving to the next step");
              if (
                membershipType === "lohono_platinum" ||
                membershipType === "not_yet"
              ) {
                initialForm.classList.add("slide-out");
                additionalForm.style.display = "block";
                additionalForm.classList.add("slide-in");
                membershipForm.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
              } else {
                initialForm.classList.add("slide-out");
                dependantForm.style.display = "block";
                dependantForm.classList.add("slide-in");
                membershipForm.scrollIntoView({
                  behavior: "smooth",
                  block: "center",
                });
                // skipButton.style.display = "block";
              }

              progressBar.style.width = "66.67%";
              nextButton.textContent = "Submit";
              termsSection.style.display = "block";
              originalText = "Submit";
              return;
            }

            // Make the API call
            const formData = JSON.parse(
              localStorage.getItem("membershipFormData")
            );
            const utmParams = JSON.parse(localStorage.getItem("utm_params"));
            const apiPayload = {
              application: {
                membership_type: formData.familyType,
                home_name: formData.homeName,
                name: formData.basicDetails.fullName,
                date_of_birth: convertDateFormat(
                  formData.basicDetails.dateOfBirth
                ),
                email: formData.basicDetails.emailId,
                country_code: formData.basicDetails.countryCode || "",
                mobile: formData.basicDetails.phoneNumber,
                utm_source: (utmParams && utmParams.utm_source) || "",
                utm_medium: (utmParams && utmParams.utm_medium) || "",
                utm_campaign: (utmParams && utmParams.utm_campaign) || "",
                utm_term: (utmParams && utmParams.utm_term) || "",
                utm_content: (utmParams && utmParams.utm_content) || "",
                links: {
                  linkedinUrl: formData.basicDetails.linkedinUrl || "",
                  social_media_handle: formData.basicDetails.socialMediaHandle,
                },
                addresses_attributes: [
                  {
                    address_type: "permanent",
                    line_1: formData.address.line1,
                    line_2: formData.address.line2,
                    pincode: formData.address.pincode,
                    state: formData.address.state,
                  },
                  ...(formData.familyType === "lohono_platinum" ||
                  formData.familyType === "not_yet"
                    ? [
                        {
                          address_type: "goa",
                          line_1: formData.goaAddress.line1,
                          line_2: formData.goaAddress.line2,
                          pincode: formData.goaAddress.pincode,
                          state: formData.goaAddress.state,
                        },
                      ]
                    : []),
                ],
                partner_attributes: {
                  full_name: formData.partnerDetails.fullName,
                  date_of_birth: convertDateFormat(
                    formData.partnerDetails.dateOfBirth
                  ),
                  email: formData.partnerDetails.emailId,
                  country_code: "+91",
                  mobile: formData.partnerDetails.phoneNumber,
                  anniversary: convertDateFormat(
                    formData.partnerDetails.anniversary
                  ),
                  social_media_handle:
                    formData.partnerDetails.socialMediaHandle,
                },
              },
            };

            const response = await fetch(
              "https://api-staging.lohono.com/api/v1/solene/applications",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(apiPayload),
              }
            );

            if (!response.ok) {
              throw new Error("Failed to create application");
            }

            const responseData = await response.json();

            if (responseData.application && responseData.application.slug) {
              localStorage.setItem(
                "applicationSlug",
                responseData.application.slug
              );

              if (
                formData.familyType === "lohono_platinum" ||
                formData.familyType === "not_yet"
              ) {
                initialForm.classList.add("slide-out");
                additionalForm.style.display = "block";
                additionalForm.classList.add("slide-in");
              } else {
                initialForm.classList.add("slide-out");
                dependantForm.style.display = "block";
                dependantForm.classList.add("slide-in");
              }

              progressBar.style.width = "66.67%";
              termsSection.style.display = "block";
              nextButton.textContent = "Submit";
              originalText = "Submit";
            } else {
              throw new Error("Invalid response from server");
            }
          } else if (nextButton.textContent.trim().toLowerCase() === "submit") {
            if (!validateTermsAndConditions()) {
              termsSection.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });
              return;
            }
            const formData = JSON.parse(
              localStorage.getItem("membershipFormData")
            );
            const applicationSlug = localStorage.getItem("applicationSlug");
            nextButton.disabled = true;
            nextButton.classList.add("loading");
            if (!applicationSlug) {
              showToast("Application not found. Please try again.", error);
              return;
            }
            if (
              formData.familyType === "isprava_homeowner" ||
              formData.familyType === "chapter_homeowner"
            ) {
              // Validate dependents if any field is filled
              if (!validateDependents()) {
                const firstError = document.querySelector(".error-message");
                if (firstError) {
                  firstError.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                  });
                }
                return;
              }
            }
            if (
              formData.familyType === "lohono_platinum" ||
              formData.familyType === "not_yet"
            ) {
              // if (!validateSourceCheckboxes()) {
              //   document.querySelector(".checkbox-group")?.scrollIntoView({
              //     behavior: "smooth",
              //     block: "center",
              //   });
              //   return;
              // }
              if (!hasAdditionalInfoData()) {
                // Skip API call and proceed to success page
                showToast("Form submitted successfully!");
                localStorage.clear();
                setTimeout(() => {
                  window.location.href = "success.html";
                }, 500);
                return;
              }
              const referenceFullName = document
                .getElementById("reference-full-name")
                .value.trim();
              const referencePhoneNumber = document
                .getElementById("reference-phone-number")
                .value.trim();
              const referenceRelationship = document
                .getElementById("reference-relationship")
                .value.trim();
              const additionalFormData = {
                sources_data: {
                  hear_via_member: document.getElementById("member").checked,
                  referrer: {
                    name: referenceFullName,
                    phone: referencePhoneNumber,
                    relationship: referenceRelationship,
                  },
                },
                additional_data: {
                  reason_to_join: document.getElementById("why").value,
                  usage_plan: document.getElementById("how").value,
                },
              };

              const response = await fetch(
                `https://api-staging.lohono.com/api/v1/solene/applications/${applicationSlug}/additional_information`,
                {
                  method: "PATCH",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(additionalFormData),
                }
              );

              if (!response.ok) {
                throw new Error("Failed to save additional information");
              }
            } else {
              if (!hasDependantData()) {
                // Skip API call and proceed to success page
                showToast("Form submitted successfully!");
                localStorage.clear();
                setTimeout(() => {
                  window.location.href = "success.html";
                }, 500);
                return;
              }
              const dependantSections = document.querySelectorAll(
                "#dependants-container .form-section"
              );
              const dependants = Array.from(dependantSections).map(
                (section, index) => ({
                  full_name:
                    document.getElementById(`dependant-${index + 1}-full-name`)
                      ?.value || "",
                  date_of_birth: convertDateFormat(
                    document.getElementById(
                      `dependant-${index + 1}-date-of-birth`
                    )?.value || ""
                  ),
                  email:
                    document.getElementById(`dependant-${index + 1}-email`)
                      ?.value || "",
                  country_code: "+91",
                  mobile:
                    document.getElementById(
                      `dependant-${index + 1}-phone-number`
                    )?.value || "",
                  relationship:
                    document.getElementById(
                      `dependant-${index + 1}-relationship`
                    )?.value || "",
                  social_media_handle:
                    document.getElementById(
                      `dependant-${index + 1}-social-media`
                    )?.value || "",
                })
              );

              const response = await fetch(
                `https://api-staging.lohono.com/api/v1/solene/applications/${applicationSlug}/dependants/add_multiple`,
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({ dependants }),
                }
              );

              if (!response.ok) {
                throw new Error("Failed to save dependants");
              }
            }

            showToast("Form submitted successfully!");
            localStorage.clear();
            setTimeout(() => {
              window.location.href = "success.html";
            }, 500);
          }
        } catch (error) {
          console.error("Error:", error);
          showToast(
            error.message || "An error occurred. Please try again.",
            "error"
          );
        } finally {
          nextButton.disabled = false;
          nextButton.classList.remove("loading");
          nextButton.textContent = "Submit";
        }
      });

      previousButton.addEventListener("click", async function () {
        const familyType = await localStorage.getItem("familyType");
        initialForm.classList.remove("slide-out");
        dependantForm.classList.remove("slide-in");
        additionalForm.classList.remove("slide-in");
        termsSection.style.display = "none";
        progressBar.style.width = "33.33%";
        nextButton.textContent = "Next";
        skipButton.style.display = "none";
        originalText = "Next";
      });

      document
        .getElementById("add-dependant-btn")
        ?.addEventListener("click", function () {
          const dependantCount = document.querySelectorAll(
            "#dependants-container .form-section"
          ).length;

          const newDependantSection = document.createElement("div");
          newDependantSection.className = "form-section";
          newDependantSection.innerHTML = `
        <div class="dependant-header">
          <h3>Dependant ${dependantCount + 1}</h3>
          ${
            dependantCount > 0
              ? '<button class="remove-dependant">Remove</button>'
              : ""
          }
        </div>
        <div class="form-grid">
          <div class="form-field">
            <input type="text" id="dependant-${
              dependantCount + 1
            }-full-name" placeholder=" " required />
            <label for="dependant-${
              dependantCount + 1
            }-full-name">Full Name</label>
          </div>
          <div class="form-field">
            <input type="text" id="dependant-${
              dependantCount + 1
            }-date-of-birth" placeholder="DD/MM/YYYY" required />
            <label for="dependant-${
              dependantCount + 1
            }-date-of-birth" style="padding-right: 6px">Date of Birth</label>
          </div>
          <div class="form-field phone-field">
            <div class="country-code" id="dependant-${
              dependantCount + 1
            }-country-code">
              <span>+91 India</span>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </div>
            <div class="country-dropdown">
              <div class="country-option selected" data-code="+91" data-country="India">
                <span class="country-name">India</span>
                <span class="country-dial-code">+91</span>
              </div>
              <div class="country-option" data-code="+1" data-country="United States">
                <span class="country-name">United States</span>
                <span class="country-dial-code">+1</span>
              </div>
              <div class="country-option" data-code="+1" data-country="Canada">
                <span class="country-name">Canada</span>
                <span class="country-dial-code">+1</span>
              </div>
              <div class="country-option" data-code="+44" data-country="United Kingdom">
                <span class="country-name">United Kingdom</span>
                <span class="country-dial-code">+44</span>
              </div>
              <div class="country-option" data-code="+65" data-country="Singapore">
                <span class="country-name">Singapore</span>
                <span class="country-dial-code">+65</span>
              </div>
              <div class="country-option" data-code="+971" data-country="United arab emirates">
                <span class="country-name">United arab emirates</span>
                <span class="country-dial-code">+971</span>
              </div>
            </div>
            <div class="divider"></div>
            <input type="tel" id="dependant-${
              dependantCount + 1
            }-phone-number" placeholder=" " required />
            <label for="dependant-${
              dependantCount + 1
            }-phone-number">Phone Number</label>
          </div>
          <div class="form-field">
            <input type="email" id="dependant-${
              dependantCount + 1
            }-email" placeholder=" " required />
            <label for="dependant-${dependantCount + 1}-email">Email ID*</label>
          </div>
          <div class="form-field">
            <select id="dependant-${dependantCount + 1}-relationship" required>
              <option value="" disabled selected></option>
              <option value="mother">Mother</option>
              <option value="father">Father</option>
              <option value="son">Son</option>
              <option value="daughter">Daughter</option>
            </select>
            <label for="dependant-${
              dependantCount + 1
            }-relationship">Relationship*</label>
          </div>
          <div class="form-field">
            <input type="text" id="dependant-${
              dependantCount + 1
            }-social-media" placeholder=" " />
            <label for="dependant-${
              dependantCount + 1
            }-social-media">Social Media Handle</label>
          </div>
        </div>
      `;

          const container = document.getElementById("dependants-container");
          const addDependantButton = container.querySelector(".add-dependant");
          container.insertBefore(newDependantSection, addDependantButton);
          container.insertBefore(
            document.createElement("div"),
            addDependantButton
          ).className = "separator";

          newDependantSection
            .querySelectorAll(".form-field input, .form-field select")
            .forEach((input) => {
              input.addEventListener("focus", function () {
                const label = this.nextElementSibling;
                if (label && label.tagName === "LABEL") {
                  label.classList.add("active");
                }
              });

              input.addEventListener("blur", function () {
                const label = this.nextElementSibling;
                if (label && label.tagName === "LABEL" && this.value === "") {
                  label.classList.remove("active");
                }
                if (this.hasAttribute("required")) {
                  validateField(this);
                }
              });
            });

          initializeNewDependantDropdowns(newDependantSection);

          // Hide remove buttons on all sections except the last one
          const dependantSections = document.querySelectorAll(
            "#dependants-container .form-section"
          );
          dependantSections.forEach((section, index) => {
            const removeBtn = section.querySelector(".remove-dependant");
            if (removeBtn) {
              removeBtn.style.display =
                index === dependantSections.length - 1 ? "block" : "none";
            }
          });
        });

      document
        .getElementById("dependants-container")
        .addEventListener("click", function (e) {
          if (e.target.classList.contains("remove-dependant")) {
            const section = e.target.closest(".form-section");
            const separator = section.nextElementSibling;

            // Remove the section and its separator
            section.remove();
            if (separator && separator.classList.contains("separator")) {
              separator.remove();
            }

            // Update the numbering of remaining dependants
            const dependantSections = document.querySelectorAll(
              "#dependants-container .form-section"
            );
            dependantSections.forEach((section, index) => {
              const header = section.querySelector("h3");
              header.textContent = `Dependant ${index + 1}`;

              // Show remove button only for the last dependant
              const removeBtn = section.querySelector(".remove-dependant");
              if (removeBtn) {
                removeBtn.style.display =
                  index === dependantSections.length - 1 && index > 0
                    ? "block"
                    : "none";
              }
            });

            // Save updated dependants data
            saveDependantsData();
          }
        });

      document.getElementById("other")?.addEventListener("change", function () {
        const otherInput = document.querySelector(".other-input input");
        otherInput.disabled = !this.checked;
      });

      const savedFormData = localStorage.getItem("membershipFormData");
      if (savedFormData) {
        const formData = JSON.parse(savedFormData);

        if (formData.familyType) {
          const radioButton = document.querySelector(
            `input[name="family"][value="${formData.familyType}"]`
          );
          if (radioButton) {
            radioButton.checked = true;
            if (
              ["isprava_homeowner", "chapter_homeowner"].includes(
                formData.familyType
              )
            ) {
              document.getElementById("home-name-field").style.display =
                "block";
            } else if (
              formData.familyType === "not_yet" ||
              formData.familyType === "lohono_platinum"
            ) {
              document.getElementById("goa-address-section").style.display =
                "block";
            }
          }
        }

        if (formData.homeName) {
          document.getElementById("home-name").value = formData.homeName;
        }

        const basicDetails = formData.basicDetails;
        if (basicDetails) {
          document.getElementById("full-name").value = basicDetails.fullName;
          document.getElementById("date-of-birth").value =
            basicDetails.dateOfBirth;
          document.getElementById("phone-number").value =
            basicDetails.phoneNumber;
          document.getElementById("email-id").value = basicDetails.emailId;
          document.getElementById("linkedin-url").value =
            basicDetails.linkedinUrl || "";
          document.getElementById("social-media-handle").value =
            basicDetails.socialMediaHandle;
        }

        const address = formData.address;
        if (address) {
          document.getElementById("address-line-1").value = address.line1;
          document.getElementById("address-line-2").value = address.line2;
          document.getElementById("pincode").value = address.pincode;
          document.getElementById("state").value = address.state;
        }

        const goaAddress = formData.goaAddress;
        if (goaAddress) {
          document.getElementById("goa-address-line-1").value =
            goaAddress.line1;
          document.getElementById("goa-address-line-2").value =
            goaAddress.line2;
          document.getElementById("goa-pincode").value = goaAddress.pincode;
        }

        const partnerDetails = formData.partnerDetails;
        if (partnerDetails) {
          document.getElementById("partner-full-name").value =
            partnerDetails.fullName;
          document.getElementById("partner-date-of-birth").value =
            partnerDetails.dateOfBirth;
          document.getElementById("partner-phone-number").value =
            partnerDetails.phoneNumber;
          document.getElementById("partner-email-id").value =
            partnerDetails.emailId;
          document.getElementById("partner-anniversary").value =
            partnerDetails.anniversary;
          document.getElementById("partner-social-media-handle").value =
            partnerDetails.socialMediaHandle;
        }

        document
          .querySelectorAll(".form-field input, .form-field select")
          .forEach((input) => {
            if (input.value) {
              const label = input.nextElementSibling;
              if (label && label.tagName === "LABEL") {
                label.classList.add("active");
              }
            }
          });
      }

      const savedDependantsData = localStorage.getItem("dependantsData");
      if (savedDependantsData) {
        const dependants = JSON.parse(savedDependantsData);
        dependants.forEach((dependant, index) => {
          if (index > 0) {
            document.getElementById("add-dependant-btn")?.click();
          }

          document.getElementById(`dependant-${index + 1}-full-name`).value =
            dependant.fullName;
          document.getElementById(
            `dependant-${index + 1}-date-of-birth`
          ).value = dependant.dateOfBirth;
          document.getElementById(`dependant-${index + 1}-phone-number`).value =
            dependant.phoneNumber;
          document.getElementById(`dependant-${index + 1}-email`).value =
            dependant.emailId;
          document.getElementById(`dependant-${index + 1}-relationship`).value =
            dependant.relationship;
          document.getElementById(`dependant-${index + 1}-social-media`).value =
            dependant.socialMediaHandle;

          document
            .querySelectorAll(
              `#dependant-${index + 1}-full-name, #dependant-${
                index + 1
              }-date-of-birth, #dependant-${
                index + 1
              }-phone-number, #dependant-${index + 1}-email, #dependant-${
                index + 1
              }-relationship, #dependant-${index + 1}-social-media`
            )
            .forEach((input) => {
              if (input.value) {
                const label = input.nextElementSibling;
                if (label && label.tagName === "LABEL") {
                  label.classList.add("active");
                }
              }
            });
        });
      }

      // Function to get UTM parameters from the query string
      function getQueryParams() {
        const params = new URLSearchParams(window.location.search);
        const utmParams = {};

        // List of UTM parameters to check
        const utmKeys = [
          "utm_source",
          "utm_medium",
          "utm_campaign",
          "utm_term",
          "utm_content",
        ];

        utmKeys.forEach((key) => {
          if (params.has(key)) {
            utmParams[key] = params.get(key);
          }
        });

        return utmParams;
      }

      // Save UTM parameters to session storage
      function saveUtmToSessionStorage() {
        const utmParams = getQueryParams();
        if (Object.keys(utmParams).length > 0) {
          localStorage.setItem("utm_params", JSON.stringify(utmParams));
        }
      }

      // Run the function on page load
      document.addEventListener("DOMContentLoaded", saveUtmToSessionStorage);
    </script>
  </body>
</html>
